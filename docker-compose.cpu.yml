# =============================================================================
# AutoScoring Docker Compose - CPU Only Version
# Lab FKI Universitas Muhammadiyah Surakarta
# =============================================================================
# Usage: docker-compose -f docker-compose.cpu.yml up -d
# =============================================================================
services:
  autoscoring:
    build:
      context: .
      dockerfile: Dockerfile.cpu
    container_name: autoscoring-cpu
    restart: unless-stopped
    
    ports:
      - "5005:5005"
    
    volumes:
      # Persist database
      - ./data:/app/instance
      # Persist logs
      - ./logs:/app/logs
      # Persist results (optional)
      - ./results:/app/results
    
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - DATABASE_URL=sqlite:////app/instance/autoscoring.db
      - MAX_PDF_COUNT=${MAX_PDF_COUNT:-50}
      - MAX_WORKERS=${MAX_WORKERS:-4}
      - ENABLE_OCR=${ENABLE_OCR:-true}
      - ENABLE_CLEANUP=${ENABLE_CLEANUP:-true}
      # Active LLM provider and model
      - LLM_PROVIDER=${LLM_PROVIDER:-gemini}
      - LLM_MODEL=${LLM_MODEL:-gemini-2.5-flash}
      # Gemini API Keys
      - GEMINI_API_KEY_1=${GEMINI_API_KEY_1}
      - GEMINI_API_KEY_2=${GEMINI_API_KEY_2}
      - GEMINI_API_KEY_3=${GEMINI_API_KEY_3}
      - GEMINI_API_KEY_4=${GEMINI_API_KEY_4}
      - GEMINI_API_KEY_5=${GEMINI_API_KEY_5}
      - GEMINI_API_KEY_6=${GEMINI_API_KEY_6}
      - GEMINI_API_KEY_7=${GEMINI_API_KEY_7}
      - GEMINI_API_KEY_8=${GEMINI_API_KEY_8}
      - GEMINI_API_KEY_9=${GEMINI_API_KEY_9}
      - GEMINI_API_KEY_10=${GEMINI_API_KEY_10}
      - GEMINI_API_KEY_11=${GEMINI_API_KEY_11}
      - GEMINI_API_KEY_12=${GEMINI_API_KEY_12}
      - GEMINI_API_KEY_13=${GEMINI_API_KEY_13}
      - GEMINI_API_KEY_14=${GEMINI_API_KEY_14}
      - GEMINI_API_KEY_15=${GEMINI_API_KEY_15}
      - GEMINI_API_KEY_16=${GEMINI_API_KEY_16}
      - GEMINI_API_KEY_17=${GEMINI_API_KEY_17}
      - GEMINI_API_KEY_18=${GEMINI_API_KEY_18}
      - GEMINI_API_KEY_19=${GEMINI_API_KEY_19}
      - GEMINI_API_KEY_20=${GEMINI_API_KEY_20}
      # OpenAI-compatible providers
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      - NVIDIA_BASE_URL=${NVIDIA_BASE_URL:-https://integrate.api.nvidia.com/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - SILICONFLOW_BASE_URL=${SILICONFLOW_BASE_URL:-https://api.siliconflow.cn/v1}
      - GITHUB_API_KEY=${GITHUB_API_KEY}
      - GITHUB_BASE_URL=${GITHUB_BASE_URL:-https://models.github.ai/inference}
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/login"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
